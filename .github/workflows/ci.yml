name: CI

on:
  push:
    branches: [main]
    tags-ignore: ['**']
  pull_request:
    branches: [main]

jobs:
  analyze:
    name: Analyze
    runs-on: ${{ matrix.os }}
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: rust
            os: ubuntu-latest
          - language: swift
            os: macos-latest
          - language: csharp
            os: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
        queries: security-and-quality
        build-mode: manual

    - name: Setup .NET (for C#)
      if: matrix.language == 'csharp'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Setup Rust (for C#)
      if: matrix.language == 'csharp'
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc

    - name: Setup ImageMagick (for C#)
      if: matrix.language == 'csharp'
      run: choco install imagemagick

    - name: Setup Rust (for Swift)
      if: matrix.language == 'swift'
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin,x86_64-apple-darwin

    - name: Build Rust (for Swift)
      if: matrix.language == 'swift'
      run: |
        cd core
        cargo build --release --target aarch64-apple-darwin
        cargo build --release --target x86_64-apple-darwin
        lipo -create \
          target/aarch64-apple-darwin/release/libgonhanh_core.a \
          target/x86_64-apple-darwin/release/libgonhanh_core.a \
          -output ../platforms/macos/libgonhanh_core.a
        cd ../platforms/macos
        xcodebuild build -scheme GoNhanh -configuration Release CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

    - name: Build C#
      if: matrix.language == 'csharp'
      shell: pwsh
      run: |
        ./scripts/build-core-windows.ps1
        cd platforms/windows/GoNhanh
        # Convert logo.png to app.ico using ImageMagick
        if (Get-Command magick -ErrorAction SilentlyContinue) {
          magick ../../../assets/logo.png -define icon:auto-resize=256,128,64,48,32,16 Resources/Icons/app.ico
        }
        dotnet build -c Release

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4

  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core
      - run: cargo fmt --manifest-path core/Cargo.toml -- --check
      - run: cargo clippy --manifest-path core/Cargo.toml -- -D warnings
      - run: cargo test --manifest-path core/Cargo.toml

  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core
      - run: cargo build --manifest-path core/Cargo.toml --release

